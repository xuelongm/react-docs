<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>commit 阶段 | React Docs</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="docs React 17x">
    
    <link rel="preload" href="/react-docs/assets/css/0.styles.81a1deae.css" as="style"><link rel="preload" href="/react-docs/assets/js/app.ca115495.js" as="script"><link rel="preload" href="/react-docs/assets/js/2.e8a0a8e6.js" as="script"><link rel="preload" href="/react-docs/assets/js/10.3dc71f05.js" as="script"><link rel="prefetch" href="/react-docs/assets/js/11.e31c1489.js"><link rel="prefetch" href="/react-docs/assets/js/12.26e151f8.js"><link rel="prefetch" href="/react-docs/assets/js/3.8454ca46.js"><link rel="prefetch" href="/react-docs/assets/js/4.37b04ccd.js"><link rel="prefetch" href="/react-docs/assets/js/5.742fc857.js"><link rel="prefetch" href="/react-docs/assets/js/6.4931ac58.js"><link rel="prefetch" href="/react-docs/assets/js/7.f4004c7c.js"><link rel="prefetch" href="/react-docs/assets/js/8.47df6222.js"><link rel="prefetch" href="/react-docs/assets/js/9.5e1cfa3f.js">
    <link rel="stylesheet" href="/react-docs/assets/css/0.styles.81a1deae.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/react-docs/" class="home-link router-link-active"><!----> <span class="site-name">React Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/react-docs/" class="nav-link">
  Home
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/react-docs/" class="nav-link">
  Home
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/react-docs/" aria-current="page" class="sidebar-link">首页</a></li><li><a href="/react-docs/concept.html" class="sidebar-link">概念篇</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>render</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="commit-阶段"><a href="#commit-阶段" class="header-anchor">#</a> commit 阶段</h1> <p>上一节我们讲完了render阶段，本章节我们将要进入commit阶段的学习。</p> <p>在进入章节之前要牢记几件事：</p> <ul><li>用于副作用的effectList单项链表已形成，<code>rootFiber.firstEffect</code>指向当前要更新的第一个节点</li> <li>用于<code>mount</code>的dom创建</li> <li></li></ul> <p>commit阶段的入口函数是<code>commitRoot()</code>，此函数在<code>performSyncWorkOnRoot()</code>和<code>finishConcurrentRender()</code>函数中调用。在commit阶段是同步执行的，不可以被打断，也就是说所有的更新需要一次性完成。</p> <p>我们以<code>performSyncWorkOnRoot()</code>为例，看看<code>commitRoot()</code>的调用：</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// ...省略大部分代码</span>
    <span class="token comment">// render阶段的入口函数</span>
    exitStatus <span class="token operator">=</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...省略代码</span>
    <span class="token comment">// commitRoot函数调用</span>
    <span class="token keyword">const</span> finishedWork<span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
    <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...省略代码</span>
<span class="token punctuation">}</span>
</code></pre></div><p>有上述代码可知，在调用render阶段完成后，获取<code>workInProgress</code>的<code>rootFiber</code>节点，并将<code>rootFiber</code>节点传入<code>commitRoot</code>中。现在就让我们揭开<code>commitRoot</code>的神秘面纱。</p> <p>😭，commitRoot代码就5行，只是用<code>runWithPriority</code>调起一个任务，也就是说所有的逻辑都是在<code>commitRootImpl</code>函数中</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> renderPriorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">runWithPriority</span><span class="token punctuation">(</span>
      ImmediateSchedulerPriority<span class="token punctuation">,</span>
      <span class="token function">commitRootImpl</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>commitRootImpl</code>函数全部代码有371行，看这么长的代码就是一种折磨，不过我们可以只关注代码中最主要的功能就好，主要有以下几个功能：</p> <ul><li>处理rootFiber节点，将rootFiber节点加入到effectList中</li> <li>调用<code>commitBeforeMutationEffects</code>函数（before mutation）</li> <li>调用<code>commitMutationEffects</code>函数（mutation）</li> <li>调用<code>commitLayoutEffects</code>函数（layout）</li></ul> <p>那么这个三个函数有做了写什么呢？下面我们一一分析</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">commitRootImpl</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...省略代码</span>

    <span class="token comment">// 获取effectList</span>
    <span class="token keyword">let</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&gt;</span> PerformedWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 因为rootFiber在render阶段不会加入到链表，此时我们要把rootFiber节点加入到链表中</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        finishedWork<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
        firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// There is no effect on the root.</span>
      firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...省略代码</span>
    <span class="token comment">// 操作DOM之前的操作</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token comment">// 会调用getSnxapshotBeforeUpdate函数</span>
      <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// We no longer need to track the active instance fiber</span>
    focusedInstanceHandle <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Mark the current commit time to be shared by all Profilers in this</span>
      <span class="token comment">// batch. This enables them to be grouped later.</span>
      <span class="token function">recordCommitTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The next phase is the mutation phase, where we mutate the host tree.</span>
    <span class="token comment">// 此阶段会修改DOM</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token comment">// 解绑ref，调用useLayoutEffect销毁函数, 调用DOM操作</span>
      <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...省略代码</span>
    <span class="token comment">// 将workProgress 赋值到当前的current</span>
    <span class="token comment">// 此处很重要</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>

    <span class="token comment">// 操作DOM树</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用生命周期，调用useLayoutEffect，讲useEffect放入到数组中，绑定ref</span>
      <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>å
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">//...省略代码</span>
  
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="beforemutation"><a href="#beforemutation" class="header-anchor">#</a> beforeMutation</h2> <ul><li>处理blur和focus相关逻辑</li> <li>对于class component类型，如果有<code>Snapshot</code>，会在<code>commitBeforeMutationEffectOnFiber</code>中调用<code>getSnapshotBeforeUpdate</code></li> <li>调用useEffect</li></ul> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldFireAfterActiveInstanceBlur <span class="token operator">&amp;&amp;</span> focusedInstanceHandle <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">]</span><span class="token comment">// 处理blur和focus相关逻辑</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> flags <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setCurrentDebugFiberInDEV</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果current 为ClassComponent 则会调用getSnapshotBeforeUpdate</span>
      <span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">resetCurrentDebugFiberInDEV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调度effect</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="getsnapshotbeforeupdate调用"><a href="#getsnapshotbeforeupdate调用" class="header-anchor">#</a> <code>getSnapshotBeforeUpdate</code>调用</h3> <p>我们知道在React16后，componentWillxxx生命周期都加上了<code>UNSAFE_</code>前缀。这是因为这些生命周期都是在render阶段调用的，而在concurrent模式下render阶段可以被打断和重新调用，也就会导致这些方法多次的调用。</p> <p>而<code>getSnapshotBeforeUpdate</code>是在commit阶段调用的，commit阶段是同步执行的，所以不会出现多次调用的情况。</p> <p>如果在Class Compenent中添加了<code>getSnapshotBeforeUpdate</code>函数，再添加<code>UNSAFE_componentWillMount/componentWillMount</code>，<code>UNSAFE_componentWillReceiveProps/componentWillReceiveProps</code>和<code>UNSAFE_componentWillUpdate/componentWillUpdate</code>都不会在被调用</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">const</span> hasNewLifecycles <span class="token operator">=</span>
    <span class="token keyword">typeof</span> getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
    <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">;</span>

 <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span>hasNewLifecycles <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
        <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instance<span class="token punctuation">.</span><span class="token function">componentWillUpdate</span><span class="token punctuation">(</span>newProps<span class="token punctuation">,</span> newState<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instance<span class="token punctuation">.</span><span class="token function">UNSAFE_componentWillUpdate</span><span class="token punctuation">(</span>newProps<span class="token punctuation">,</span> newState<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>总而言之，<code>getSnapshotBeforeUpdate</code>是为了解决异步调用过程中的多次调用问题，我们在代码中应该尽量使用<code>getSnapshotBeforeUpdate</code>来代替原来的生命周期。</p> <h3 id="调用useeffect"><a href="#调用useeffect" class="header-anchor">#</a> 调用useEffect</h3> <p>在beforeMutitation阶段，会将useEffect加入到调度任务中，详细解析会在后面讲解useEffect时详细讲解。</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code> <span class="token comment">// 调度effect</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// 异步调度useEffect</span>
  <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么React为什么会异步调度useEffect呢？</p> <p>与 <code>componentDidMount</code>、<code>componentDidUpdate</code> 不同的是，传给 <code>useEffect</code> 的函数会在浏览器完成布局与绘制<strong>之后</strong>，在一个延迟事件中被调用。这使得它适用于许多常见的副作用场景，比如设置订阅和事件处理等情况，因为绝大多数操作不应阻塞浏览器对屏幕的更新。</p> <p>然而，并非所有 effect 都可以被延迟执行。例如，一个对用户可见的 DOM 变更就必须在浏览器执行下一次绘制前被同步执行，这样用户才不会感觉到视觉上的不一致。（概念上类似于被动监听事件和主动监听事件的区别。）React 为此提供了一个额外的 <a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#uselayouteffect" target="_blank" rel="noopener noreferrer"><code>useLayoutEffect</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Hook 来处理这类 effect。它和 <code>useEffect</code> 的结构相同，区别只是调用时机不同。</p> <p>虽然 <code>useEffect</code> 会在浏览器绘制后延迟执行，但会保证在任何新的渲染前执行。在开始新的更新前，React 总会先清除上一轮渲染的 effect。</p> <blockquote><p><a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#timing-of-effects" target="_blank" rel="noopener noreferrer">以上来自官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>在beforeMutation阶段会做三件事：</p> <ul><li>处理blur和focus DOM节点</li> <li>调度<code>getSnapshotBeforeUpdate</code>生命周期</li> <li>调度useEffect（注意是调度，不是调用）</li></ul> <h2 id="mutation阶段"><a href="#mutation阶段" class="header-anchor">#</a> Mutation阶段</h2> <p>mutation阶段的入口是<code>commitMutationEffects</code></p> <div class="language-tsx extra-class"><pre class="language-tsx"><code>nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
  <span class="token comment">// mutation阶段的入口函数</span>
  <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>commitMutationEffects</code>函数如下：</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>
<span class="token parameter">root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
 renderPriorityLevel<span class="token operator">:</span> ReactPriorityLevel<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setCurrentDebugFiberInDEV</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> flags <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> ContentReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commitResetTextContent</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 解绑ref</span>
        <span class="token function">commitDetachRef</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableScopeAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 下面是临时方案，可以忽略</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextEffect<span class="token punctuation">.</span>tag <span class="token operator">===</span> ScopeComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">commitAttachRef</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> primaryFlags <span class="token operator">=</span> flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Update <span class="token operator">|</span> Deletion <span class="token operator">|</span> Hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 插入节点</span>
      <span class="token keyword">case</span> Placement<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is</span>
        <span class="token comment">// inserted, before any life-cycles like componentDidMount gets called.</span>
        <span class="token comment">// TODO: findDOMNode doesn't rely on this any more but isMounted does</span>
        <span class="token comment">// and isMounted is deprecated anyway so we should be able to kill this.</span>
        nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
			<span class="token comment">// 插入并更新节点</span>
      <span class="token keyword">case</span> PlacementAndUpdate<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is</span>
        <span class="token comment">// inserted, before any life-cycles like componentDidMount gets called.</span>
        nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>

        <span class="token comment">// Update</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 服务端渲染 ssr</span>
      <span class="token keyword">case</span> Hydrating<span class="token operator">:</span> <span class="token punctuation">{</span>
        nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 服务端渲染</span>
      <span class="token keyword">case</span> HydratingAndUpdate<span class="token operator">:</span> <span class="token punctuation">{</span>
        nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>

        <span class="token comment">// Update</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 更新</span>
      <span class="token keyword">case</span> Update<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 删除</span>
      <span class="token keyword">case</span> Deletion<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">resetCurrentDebugFiberInDEV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>commitMutationEffects</code>遍历全部的effectList，对每个节点做如下处理（忽略SSR相关）</p> <ul><li>重置text</li> <li>解绑ref</li> <li>根据Fiber节点的<code>flag</code>类型，决定对DOM节点要做的操作，包括增删改</li></ul> <h3 id="增-placement"><a href="#增-placement" class="header-anchor">#</a> 增（Placement）</h3> <p>增加功能的入口为<code>commitPlacement</code>，<code>commitPlacement</code>代码大致如下：</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter">finishedWork<span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 当前环境支持Mutation</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsMutation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  	<span class="token comment">// 获取有DOM节点的parent节点，tag类型包括HostComponent，HostRoot，HostPortal，FundamentalComponent</span>
    <span class="token keyword">const</span> parentFiber <span class="token operator">=</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// DOM Parent</span>
    <span class="token keyword">let</span> parent<span class="token punctuation">;</span>
  	<span class="token comment">// 是否为root container</span>
    <span class="token keyword">let</span> isContainer<span class="token punctuation">;</span>
    <span class="token keyword">const</span> parentStateNode <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>parentFiber<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> HostComponent<span class="token operator">:</span>
        parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">;</span>
        isContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> HostRoot<span class="token operator">:</span>
        parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
        isContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> HostPortal<span class="token operator">:</span>
        parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
        isContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> FundamentalComponent<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enableFundamentalAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
          isContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// eslint-disable-next-line-no-fallthrough</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">invariant</span><span class="token punctuation">(</span>
          <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token string">'Invalid host parent fiber. This error is likely caused by a bug '</span> <span class="token operator">+</span>
          <span class="token string">'in React. Please file an issue.'</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentFiber<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ContentReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 重置textContent</span>
      <span class="token function">resetTextContent</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Clear ContentReset from the effect tag</span>
      parentFiber<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>ContentReset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  	<span class="token comment">// 获取当前节点的兄弟节点</span>
    <span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
 		<span class="token comment">// 插入节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>commitPlacement</code>主要完成一下几件事：</p> <ul><li>获取有DOM节点的Fiber节点，入口函数为<code>getHostParentFiber</code></li> <li>获取Parent DOM节点</li> <li>获取当前节点的DOM节点的兄弟DOM节点，入口函数为<code>getHostSibling</code></li> <li>插入节点，入口函数为<code>insertOrAppendPlacementNodeIntoContainer</code>和<code>insertOrAppendPlacementNode</code></li></ul> <p>以上几件事最主要的是获取兄弟节点和插入节点。</p> <h4 id="gethostsibling"><a href="#gethostsibling" class="header-anchor">#</a> getHostSibling</h4> <p><code>getHostSibling</code>获取兄弟DOM节点是很有意思的算法，因为Fiber节点不止包括<code>HostComponent</code>节点，还包括<code>ClassComponent</code>等节点，也就是DOM节点和Fiber节点不是同级的。如下面的例子：</p> <div class="language-react extra-class"><pre class="language-text"><code>function Test() {
  return (
    &lt;div&gt;1212&lt;/div&gt;
  )
}

class App extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      isShow: false,
    }
  }

  updateCount() {
    this.setState({isShow: !this.state.isShow});
  }

  render() {
    const pNode = this.state.isShow ? &lt;p&gt;test&lt;/p&gt; : null;
    return (
      &lt;div&gt;
        {pNode}
        &lt;Test&gt;&lt;/Test&gt;
        &lt;button onClick={() =&gt; this.updateCount()}&gt;click me&lt;/button&gt;
      &lt;/div&gt;
    )
  }
}
</code></pre></div><p>Fiber节点如下：</p> <ul><li>this.state.isShow === false</li></ul> <p>Fiber 树</p> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph LR
	APP --&gt; DIV
	DIV --&gt; TEST
	DIV --&gt; BUTTON
	TEST --&gt; TESTDIV
</code></pre></div><p>DOM树</p> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph LR
	DIV --&gt; TESTDIV
	DIV --&gt; BUTTON
  
</code></pre></div><ul><li>this.state.isShow === ture</li></ul> <p>Fiber 树</p> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph LR
	APP --&gt; DIV
	DIV --&gt; P
	DIV --&gt; TEST
	DIV --&gt; BUTTON
	TEST --&gt; TESTDIV
</code></pre></div><p>DOM树</p> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph LR
	DIV --&gt; P
	DIV --&gt; TESTDIV
	DIV --&gt; BUTTON
 
</code></pre></div><p>如上，P的兄弟节点，在DOM树上和Fiber树上是 不同级，在DOM书上，P的兄弟节点是TESTDIV，在Fiber树上P的兄弟节点是TEST。如果我们想找到P的兄弟DOM节点需要跨级寻找，树的跨级寻找的复杂度都是很高的。所以循环插入DOM可能会有性能问题。</p> <p>下面让我们来看看<code>getHostSibling</code>算法的实现：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>fiber<span class="token operator">:</span> Fiber<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>Instance <span class="token punctuation">{</span>
  <span class="token keyword">let</span> node<span class="token operator">:</span> Fiber <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
  siblings<span class="token operator">:</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果当前节点没有兄弟节点，则去查询父节点</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>sibling <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">isHostParent</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    node<span class="token punctuation">.</span>sibling<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>
    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> HostComponent <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> HostText <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> DehydratedFragment
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Placement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span> siblings<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostPortal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span> siblings<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 查找兄弟节点的子节点</span>
        node<span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Placement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="插入节点"><a href="#插入节点" class="header-anchor">#</a> 插入节点</h4> <p>插入DOM节点的入口是<code>insertOrAppendPlacementNodeIntoContainer</code>和<code>insertOrAppendPlacementNode</code>，这两个函数最终都会调用到真实DOM的<code>insertBefore</code>或函数<code>appendChild</code>。我们以<code>insertOrAppendPlacementNode</code>进行分析：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>
  node<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  before<span class="token operator">:</span> <span class="token operator">?</span>Instance<span class="token punctuation">,</span>
  parent<span class="token operator">:</span> Instance<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>tag<span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
  <span class="token keyword">const</span> isHost <span class="token operator">=</span> tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> tag <span class="token operator">===</span> HostText<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isHost <span class="token operator">||</span> <span class="token punctuation">(</span>enableFundamentalAPI <span class="token operator">&amp;&amp;</span> tag <span class="token operator">===</span> FundamentalComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果tag为HostCompponent或HostText类型，直接将DOM插入就好</span>
    <span class="token keyword">const</span> stateNode <span class="token operator">=</span> isHost <span class="token operator">?</span> node<span class="token punctuation">.</span>stateNode <span class="token operator">:</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">appendChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> HostPortal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 什么都不做</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当Tag不为以上情况下，需要递归插入</span>
    <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> sibling <span class="token operator">=</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>sibling <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>sibling<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sibling <span class="token operator">=</span> sibling<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们来分析下<code>else</code>的情况：</p> <div class="language-react extra-class"><pre class="language-text"><code>function Test() {
  return (
    &lt;p&gt;test&lt;/p&gt;
    &lt;div&gt;1212&lt;/div&gt;
  )
}

function App() {
	const [isShow, setIsShow] = useState(false);
  const setIsShowHandler = useCallback(() =&gt; setIsShow(true), []);
  const testNode = isShow ? &lt;Test&gt;&lt;/Test&gt; : null
  return (
    &lt;div&gt;
      {testNode}
      &lt;button onClick={setIsShowHandler}&gt;click me&lt;/button&gt;
    &lt;/div&gt;
  )
}
</code></pre></div><p>当我们点击按钮时，会形成这样的EffectList，App.firstEffect --&gt; Test   Test.nextEffect === null，也就是说在EffectList中只有Test Fiber加入到了EffectList中，同时Test Fiber的<code>flags</code>含有<code>Placement</code>标记，此时要循环将<code>p</code>节点和<code>div</code>节点插入到DOM中。</p> <h3 id="删除-deletion"><a href="#删除-deletion" class="header-anchor">#</a> 删除（Deletion）</h3> <p>删除逻辑的入口为<code>commitDeletion</code>，<code>commitDeletion</code>函数会调用<code>unmountHostComponents</code>，并最终在<code>unmountHostComponents</code>函数中完成删除逻辑，<code>unmountHostComponents</code>函数代码如下：</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">unmountHostComponents</span><span class="token punctuation">(</span>
<span class="token parameter">finishedRoot<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
 current<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
 renderPriorityLevel<span class="token operator">:</span> ReactPriorityLevel<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// We only have the top Fiber that was deleted but we need to recurse down its</span>
  <span class="token comment">// children to find all the terminal nodes.</span>
  <span class="token keyword">let</span> node<span class="token operator">:</span> Fiber <span class="token operator">=</span> current<span class="token punctuation">;</span>

  <span class="token comment">// Each iteration, currentParent is populated with node's host parent if not</span>
  <span class="token comment">// currentParentIsValid.</span>
  <span class="token keyword">let</span> currentParentIsValid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">// Note: these two variables *must* always be updated together.</span>
  <span class="token keyword">let</span> currentParent<span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentParentIsContainer<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentParentIsValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> parent <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>
      findParent<span class="token operator">:</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invariant</span><span class="token punctuation">(</span>
          parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token string">'Expected to find a host parent. This error is likely caused by '</span> <span class="token operator">+</span>
          <span class="token string">'a bug in React. Please file an issue.'</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> parentStateNode <span class="token operator">=</span> parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> HostComponent<span class="token operator">:</span>
            currentParent <span class="token operator">=</span> parentStateNode<span class="token punctuation">;</span>
            currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span> findParent<span class="token punctuation">;</span>
          <span class="token keyword">case</span> HostRoot<span class="token operator">:</span>
            currentParent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
            currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span> findParent<span class="token punctuation">;</span>
          <span class="token keyword">case</span> HostPortal<span class="token operator">:</span>
            currentParent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
            currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span> findParent<span class="token punctuation">;</span>
          <span class="token keyword">case</span> FundamentalComponent<span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>enableFundamentalAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              currentParent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
              currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        parent <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      currentParentIsValid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commitNestedUnmounts</span><span class="token punctuation">(</span>finishedRoot<span class="token punctuation">,</span> node<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// After all the children have unmounted, it is now safe to remove the</span>
      <span class="token comment">// node from the tree.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentParentIsContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeChildFromContainer</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> Container<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>node<span class="token punctuation">.</span>stateNode<span class="token operator">:</span> Instance <span class="token operator">|</span> TextInstance<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">removeChild</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> Instance<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>node<span class="token punctuation">.</span>stateNode<span class="token operator">:</span> Instance <span class="token operator">|</span> TextInstance<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Don't visit children because we already visited them.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>enableFundamentalAPI <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> FundamentalComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fundamentalNode <span class="token operator">=</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
      <span class="token function">commitNestedUnmounts</span><span class="token punctuation">(</span>finishedRoot<span class="token punctuation">,</span> node<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// After all the children have unmounted, it is now safe to remove the</span>
      <span class="token comment">// node from the tree.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentParentIsContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeChildFromContainer</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> Container<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>fundamentalNode<span class="token operator">:</span> Instance<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 删除真实DOM</span>
        <span class="token function">removeChild</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> Instance<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>fundamentalNode<span class="token operator">:</span> Instance<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      enableSuspenseServerRenderer <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">===</span> DehydratedFragment
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSuspenseCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> hydrationCallbacks <span class="token operator">=</span> finishedRoot<span class="token punctuation">.</span>hydrationCallbacks<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hydrationCallbacks <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> onDeleted <span class="token operator">=</span> hydrationCallbacks<span class="token punctuation">.</span>onDeleted<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>onDeleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onDeleted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>stateNode<span class="token operator">:</span> SuspenseInstance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Delete the dehydrated suspense boundary and all of its content.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentParentIsContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearSuspenseBoundaryFromContainer</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> Container<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>node<span class="token punctuation">.</span>stateNode<span class="token operator">:</span> SuspenseInstance<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">clearSuspenseBoundary</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> Instance<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>node<span class="token punctuation">.</span>stateNode<span class="token operator">:</span> SuspenseInstance<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostPortal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// When we go into a portal, it becomes the parent to remove from.</span>
        <span class="token comment">// We will reassign it back when we pop the portal on the way up.</span>
        currentParent <span class="token operator">=</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
        currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// Visit children because portals might contain host components.</span>
        node<span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">commitUnmount</span><span class="token punctuation">(</span>finishedRoot<span class="token punctuation">,</span> node<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Visit children because we may find more host components below.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>sibling <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> node<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">===</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostPortal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// When we go out of the portal, we need to restore the parent.</span>
        <span class="token comment">// Since we don't keep a stack of them, we will search for it.</span>
        currentParentIsValid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    node<span class="token punctuation">.</span>sibling<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>
    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/27/2021, 1:38:39 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/react-docs/assets/js/app.ca115495.js" defer></script><script src="/react-docs/assets/js/2.e8a0a8e6.js" defer></script><script src="/react-docs/assets/js/10.3dc71f05.js" defer></script>
  </body>
</html>

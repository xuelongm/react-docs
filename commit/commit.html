<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>commit é˜¶æ®µ | React Docs</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="docs React 17x">
    
    <link rel="preload" href="/react-docs/assets/css/0.styles.81a1deae.css" as="style"><link rel="preload" href="/react-docs/assets/js/app.c8c084ff.js" as="script"><link rel="preload" href="/react-docs/assets/js/2.e8a0a8e6.js" as="script"><link rel="preload" href="/react-docs/assets/js/10.9364b8a2.js" as="script"><link rel="prefetch" href="/react-docs/assets/js/11.e31c1489.js"><link rel="prefetch" href="/react-docs/assets/js/12.26e151f8.js"><link rel="prefetch" href="/react-docs/assets/js/3.8454ca46.js"><link rel="prefetch" href="/react-docs/assets/js/4.37b04ccd.js"><link rel="prefetch" href="/react-docs/assets/js/5.742fc857.js"><link rel="prefetch" href="/react-docs/assets/js/6.4931ac58.js"><link rel="prefetch" href="/react-docs/assets/js/7.f4004c7c.js"><link rel="prefetch" href="/react-docs/assets/js/8.47df6222.js"><link rel="prefetch" href="/react-docs/assets/js/9.5e1cfa3f.js">
    <link rel="stylesheet" href="/react-docs/assets/css/0.styles.81a1deae.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/react-docs/" class="home-link router-link-active"><!----> <span class="site-name">React Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/react-docs/" class="nav-link">
  Home
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/react-docs/" class="nav-link">
  Home
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/react-docs/" aria-current="page" class="sidebar-link">é¦–é¡µ</a></li><li><a href="/react-docs/concept.html" class="sidebar-link">æ¦‚å¿µç¯‡</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>render</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="commit-é˜¶æ®µ"><a href="#commit-é˜¶æ®µ" class="header-anchor">#</a> commit é˜¶æ®µ</h1> <p>ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²å®Œäº†renderé˜¶æ®µï¼Œæœ¬ç« èŠ‚æˆ‘ä»¬å°†è¦è¿›å…¥commité˜¶æ®µçš„å­¦ä¹ ã€‚</p> <p>åœ¨è¿›å…¥ç« èŠ‚ä¹‹å‰è¦ç‰¢è®°å‡ ä»¶äº‹ï¼š</p> <ul><li>ç”¨äºå‰¯ä½œç”¨çš„effectListå•é¡¹é“¾è¡¨å·²å½¢æˆï¼Œ<code>rootFiber.firstEffect</code>æŒ‡å‘å½“å‰è¦æ›´æ–°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</li> <li>ç”¨äº<code>mount</code>çš„domåˆ›å»º</li> <li></li></ul> <p>commité˜¶æ®µçš„å…¥å£å‡½æ•°æ˜¯<code>commitRoot()</code>ï¼Œæ­¤å‡½æ•°åœ¨<code>performSyncWorkOnRoot()</code>å’Œ<code>finishConcurrentRender()</code>å‡½æ•°ä¸­è°ƒç”¨ã€‚åœ¨commité˜¶æ®µæ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œä¸å¯ä»¥è¢«æ‰“æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„æ›´æ–°éœ€è¦ä¸€æ¬¡æ€§å®Œæˆã€‚</p> <p>æˆ‘ä»¬ä»¥<code>performSyncWorkOnRoot()</code>ä¸ºä¾‹ï¼Œçœ‹çœ‹<code>commitRoot()</code>çš„è°ƒç”¨ï¼š</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// ...çœç•¥å¤§éƒ¨åˆ†ä»£ç </span>
    <span class="token comment">// renderé˜¶æ®µçš„å…¥å£å‡½æ•°</span>
    exitStatus <span class="token operator">=</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...çœç•¥ä»£ç </span>
    <span class="token comment">// commitRootå‡½æ•°è°ƒç”¨</span>
    <span class="token keyword">const</span> finishedWork<span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
    <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...çœç•¥ä»£ç </span>
<span class="token punctuation">}</span>
</code></pre></div><p>æœ‰ä¸Šè¿°ä»£ç å¯çŸ¥ï¼Œåœ¨è°ƒç”¨renderé˜¶æ®µå®Œæˆåï¼Œè·å–<code>workInProgress</code>çš„<code>rootFiber</code>èŠ‚ç‚¹ï¼Œå¹¶å°†<code>rootFiber</code>èŠ‚ç‚¹ä¼ å…¥<code>commitRoot</code>ä¸­ã€‚ç°åœ¨å°±è®©æˆ‘ä»¬æ­å¼€<code>commitRoot</code>çš„ç¥ç§˜é¢çº±ã€‚</p> <p>ğŸ˜­ï¼ŒcommitRootä»£ç å°±5è¡Œï¼Œåªæ˜¯ç”¨<code>runWithPriority</code>è°ƒèµ·ä¸€ä¸ªä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„é€»è¾‘éƒ½æ˜¯åœ¨<code>commitRootImpl</code>å‡½æ•°ä¸­</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> renderPriorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">runWithPriority</span><span class="token punctuation">(</span>
      ImmediateSchedulerPriority<span class="token punctuation">,</span>
      <span class="token function">commitRootImpl</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>commitRootImpl</code>å‡½æ•°å…¨éƒ¨ä»£ç æœ‰371è¡Œï¼Œçœ‹è¿™ä¹ˆé•¿çš„ä»£ç å°±æ˜¯ä¸€ç§æŠ˜ç£¨ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥åªå…³æ³¨ä»£ç ä¸­æœ€ä¸»è¦çš„åŠŸèƒ½å°±å¥½ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š</p> <ul><li>å¤„ç†rootFiberèŠ‚ç‚¹ï¼Œå°†rootFiberèŠ‚ç‚¹åŠ å…¥åˆ°effectListä¸­</li> <li>è°ƒç”¨<code>commitBeforeMutationEffects</code>å‡½æ•°ï¼ˆbefore mutationï¼‰</li> <li>è°ƒç”¨<code>commitMutationEffects</code>å‡½æ•°ï¼ˆmutationï¼‰</li> <li>è°ƒç”¨<code>commitLayoutEffects</code>å‡½æ•°ï¼ˆlayoutï¼‰</li></ul> <p>é‚£ä¹ˆè¿™ä¸ªä¸‰ä¸ªå‡½æ•°æœ‰åšäº†å†™ä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬ä¸€ä¸€åˆ†æ</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">commitRootImpl</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...çœç•¥ä»£ç </span>

    <span class="token comment">// è·å–effectList</span>
    <span class="token keyword">let</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&gt;</span> PerformedWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å› ä¸ºrootFiberåœ¨renderé˜¶æ®µä¸ä¼šåŠ å…¥åˆ°é“¾è¡¨ï¼Œæ­¤æ—¶æˆ‘ä»¬è¦æŠŠrootFiberèŠ‚ç‚¹åŠ å…¥åˆ°é“¾è¡¨ä¸­</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        finishedWork<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
        firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// There is no effect on the root.</span>
      firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...çœç•¥ä»£ç </span>
    <span class="token comment">// æ“ä½œDOMä¹‹å‰çš„æ“ä½œ</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä¼šè°ƒç”¨getSnxapshotBeforeUpdateå‡½æ•°</span>
      <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// We no longer need to track the active instance fiber</span>
    focusedInstanceHandle <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Mark the current commit time to be shared by all Profilers in this</span>
      <span class="token comment">// batch. This enables them to be grouped later.</span>
      <span class="token function">recordCommitTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The next phase is the mutation phase, where we mutate the host tree.</span>
    <span class="token comment">// æ­¤é˜¶æ®µä¼šä¿®æ”¹DOM</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token comment">// è§£ç»‘refï¼Œè°ƒç”¨useLayoutEffecté”€æ¯å‡½æ•°, è°ƒç”¨DOMæ“ä½œ</span>
      <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...çœç•¥ä»£ç </span>
    <span class="token comment">// å°†workProgress èµ‹å€¼åˆ°å½“å‰çš„current</span>
    <span class="token comment">// æ­¤å¤„å¾ˆé‡è¦</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>

    <span class="token comment">// æ“ä½œDOMæ ‘</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token comment">// è°ƒç”¨ç”Ÿå‘½å‘¨æœŸï¼Œè°ƒç”¨useLayoutEffectï¼Œè®²useEffectæ”¾å…¥åˆ°æ•°ç»„ä¸­ï¼Œç»‘å®šref</span>
      <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>Ã¥
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">//...çœç•¥ä»£ç </span>
  
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="beforemutation"><a href="#beforemutation" class="header-anchor">#</a> beforeMutation</h2> <ul><li>å¤„ç†blurå’Œfocusç›¸å…³é€»è¾‘</li> <li>å¯¹äºclass componentç±»å‹ï¼Œå¦‚æœæœ‰<code>Snapshot</code>ï¼Œä¼šåœ¨<code>commitBeforeMutationEffectOnFiber</code>ä¸­è°ƒç”¨<code>getSnapshotBeforeUpdate</code></li></ul> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldFireAfterActiveInstanceBlur <span class="token operator">&amp;&amp;</span> focusedInstanceHandle <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">]</span><span class="token comment">// å¤„ç†blurå’Œfocusç›¸å…³é€»è¾‘</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> flags <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setCurrentDebugFiberInDEV</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// å¦‚æœcurrent ä¸ºClassComponent åˆ™ä¼šè°ƒç”¨getSnapshotBeforeUpdate</span>
      <span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">resetCurrentDebugFiberInDEV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è°ƒåº¦effect</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/26/2021, 1:19:52 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/react-docs/assets/js/app.c8c084ff.js" defer></script><script src="/react-docs/assets/js/2.e8a0a8e6.js" defer></script><script src="/react-docs/assets/js/10.9364b8a2.js" defer></script>
  </body>
</html>

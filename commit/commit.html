<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>commit é˜¶æ®µ | React Docs</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="docs React 17x">
    
    <link rel="preload" href="/react-docs/assets/css/0.styles.81a1deae.css" as="style"><link rel="preload" href="/react-docs/assets/js/app.ca115495.js" as="script"><link rel="preload" href="/react-docs/assets/js/2.e8a0a8e6.js" as="script"><link rel="preload" href="/react-docs/assets/js/10.3dc71f05.js" as="script"><link rel="prefetch" href="/react-docs/assets/js/11.e31c1489.js"><link rel="prefetch" href="/react-docs/assets/js/12.26e151f8.js"><link rel="prefetch" href="/react-docs/assets/js/3.8454ca46.js"><link rel="prefetch" href="/react-docs/assets/js/4.37b04ccd.js"><link rel="prefetch" href="/react-docs/assets/js/5.742fc857.js"><link rel="prefetch" href="/react-docs/assets/js/6.4931ac58.js"><link rel="prefetch" href="/react-docs/assets/js/7.f4004c7c.js"><link rel="prefetch" href="/react-docs/assets/js/8.47df6222.js"><link rel="prefetch" href="/react-docs/assets/js/9.5e1cfa3f.js">
    <link rel="stylesheet" href="/react-docs/assets/css/0.styles.81a1deae.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/react-docs/" class="home-link router-link-active"><!----> <span class="site-name">React Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/react-docs/" class="nav-link">
  Home
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/react-docs/" class="nav-link">
  Home
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/react-docs/" aria-current="page" class="sidebar-link">é¦–é¡µ</a></li><li><a href="/react-docs/concept.html" class="sidebar-link">æ¦‚å¿µç¯‡</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>render</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="commit-é˜¶æ®µ"><a href="#commit-é˜¶æ®µ" class="header-anchor">#</a> commit é˜¶æ®µ</h1> <p>ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²å®Œäº†renderé˜¶æ®µï¼Œæœ¬ç« èŠ‚æˆ‘ä»¬å°†è¦è¿›å…¥commité˜¶æ®µçš„å­¦ä¹ ã€‚</p> <p>åœ¨è¿›å…¥ç« èŠ‚ä¹‹å‰è¦ç‰¢è®°å‡ ä»¶äº‹ï¼š</p> <ul><li>ç”¨äºå‰¯ä½œç”¨çš„effectListå•é¡¹é“¾è¡¨å·²å½¢æˆï¼Œ<code>rootFiber.firstEffect</code>æŒ‡å‘å½“å‰è¦æ›´æ–°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</li> <li>ç”¨äº<code>mount</code>çš„domåˆ›å»º</li> <li></li></ul> <p>commité˜¶æ®µçš„å…¥å£å‡½æ•°æ˜¯<code>commitRoot()</code>ï¼Œæ­¤å‡½æ•°åœ¨<code>performSyncWorkOnRoot()</code>å’Œ<code>finishConcurrentRender()</code>å‡½æ•°ä¸­è°ƒç”¨ã€‚åœ¨commité˜¶æ®µæ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œä¸å¯ä»¥è¢«æ‰“æ–­ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„æ›´æ–°éœ€è¦ä¸€æ¬¡æ€§å®Œæˆã€‚</p> <p>æˆ‘ä»¬ä»¥<code>performSyncWorkOnRoot()</code>ä¸ºä¾‹ï¼Œçœ‹çœ‹<code>commitRoot()</code>çš„è°ƒç”¨ï¼š</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// ...çœç•¥å¤§éƒ¨åˆ†ä»£ç </span>
    <span class="token comment">// renderé˜¶æ®µçš„å…¥å£å‡½æ•°</span>
    exitStatus <span class="token operator">=</span> <span class="token function">renderRootSync</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...çœç•¥ä»£ç </span>
    <span class="token comment">// commitRootå‡½æ•°è°ƒç”¨</span>
    <span class="token keyword">const</span> finishedWork<span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
    <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...çœç•¥ä»£ç </span>
<span class="token punctuation">}</span>
</code></pre></div><p>æœ‰ä¸Šè¿°ä»£ç å¯çŸ¥ï¼Œåœ¨è°ƒç”¨renderé˜¶æ®µå®Œæˆåï¼Œè·å–<code>workInProgress</code>çš„<code>rootFiber</code>èŠ‚ç‚¹ï¼Œå¹¶å°†<code>rootFiber</code>èŠ‚ç‚¹ä¼ å…¥<code>commitRoot</code>ä¸­ã€‚ç°åœ¨å°±è®©æˆ‘ä»¬æ­å¼€<code>commitRoot</code>çš„ç¥ç§˜é¢çº±ã€‚</p> <p>ğŸ˜­ï¼ŒcommitRootä»£ç å°±5è¡Œï¼Œåªæ˜¯ç”¨<code>runWithPriority</code>è°ƒèµ·ä¸€ä¸ªä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„é€»è¾‘éƒ½æ˜¯åœ¨<code>commitRootImpl</code>å‡½æ•°ä¸­</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> renderPriorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">runWithPriority</span><span class="token punctuation">(</span>
      ImmediateSchedulerPriority<span class="token punctuation">,</span>
      <span class="token function">commitRootImpl</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>commitRootImpl</code>å‡½æ•°å…¨éƒ¨ä»£ç æœ‰371è¡Œï¼Œçœ‹è¿™ä¹ˆé•¿çš„ä»£ç å°±æ˜¯ä¸€ç§æŠ˜ç£¨ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥åªå…³æ³¨ä»£ç ä¸­æœ€ä¸»è¦çš„åŠŸèƒ½å°±å¥½ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š</p> <ul><li>å¤„ç†rootFiberèŠ‚ç‚¹ï¼Œå°†rootFiberèŠ‚ç‚¹åŠ å…¥åˆ°effectListä¸­</li> <li>è°ƒç”¨<code>commitBeforeMutationEffects</code>å‡½æ•°ï¼ˆbefore mutationï¼‰</li> <li>è°ƒç”¨<code>commitMutationEffects</code>å‡½æ•°ï¼ˆmutationï¼‰</li> <li>è°ƒç”¨<code>commitLayoutEffects</code>å‡½æ•°ï¼ˆlayoutï¼‰</li></ul> <p>é‚£ä¹ˆè¿™ä¸ªä¸‰ä¸ªå‡½æ•°æœ‰åšäº†å†™ä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬ä¸€ä¸€åˆ†æ</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">commitRootImpl</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...çœç•¥ä»£ç </span>

    <span class="token comment">// è·å–effectList</span>
    <span class="token keyword">let</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&gt;</span> PerformedWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å› ä¸ºrootFiberåœ¨renderé˜¶æ®µä¸ä¼šåŠ å…¥åˆ°é“¾è¡¨ï¼Œæ­¤æ—¶æˆ‘ä»¬è¦æŠŠrootFiberèŠ‚ç‚¹åŠ å…¥åˆ°é“¾è¡¨ä¸­</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        finishedWork<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
        firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// There is no effect on the root.</span>
      firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...çœç•¥ä»£ç </span>
    <span class="token comment">// æ“ä½œDOMä¹‹å‰çš„æ“ä½œ</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä¼šè°ƒç”¨getSnxapshotBeforeUpdateå‡½æ•°</span>
      <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// We no longer need to track the active instance fiber</span>
    focusedInstanceHandle <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableProfilerTimer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Mark the current commit time to be shared by all Profilers in this</span>
      <span class="token comment">// batch. This enables them to be grouped later.</span>
      <span class="token function">recordCommitTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The next phase is the mutation phase, where we mutate the host tree.</span>
    <span class="token comment">// æ­¤é˜¶æ®µä¼šä¿®æ”¹DOM</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token comment">// è§£ç»‘refï¼Œè°ƒç”¨useLayoutEffecté”€æ¯å‡½æ•°, è°ƒç”¨DOMæ“ä½œ</span>
      <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...çœç•¥ä»£ç </span>
    <span class="token comment">// å°†workProgress èµ‹å€¼åˆ°å½“å‰çš„current</span>
    <span class="token comment">// æ­¤å¤„å¾ˆé‡è¦</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>

    <span class="token comment">// æ“ä½œDOMæ ‘</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token comment">// è°ƒç”¨ç”Ÿå‘½å‘¨æœŸï¼Œè°ƒç”¨useLayoutEffectï¼Œè®²useEffectæ”¾å…¥åˆ°æ•°ç»„ä¸­ï¼Œç»‘å®šref</span>
      <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>Ã¥
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">//...çœç•¥ä»£ç </span>
  
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="beforemutation"><a href="#beforemutation" class="header-anchor">#</a> beforeMutation</h2> <ul><li>å¤„ç†blurå’Œfocusç›¸å…³é€»è¾‘</li> <li>å¯¹äºclass componentç±»å‹ï¼Œå¦‚æœæœ‰<code>Snapshot</code>ï¼Œä¼šåœ¨<code>commitBeforeMutationEffectOnFiber</code>ä¸­è°ƒç”¨<code>getSnapshotBeforeUpdate</code></li> <li>è°ƒç”¨useEffect</li></ul> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldFireAfterActiveInstanceBlur <span class="token operator">&amp;&amp;</span> focusedInstanceHandle <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">]</span><span class="token comment">// å¤„ç†blurå’Œfocusç›¸å…³é€»è¾‘</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> flags <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setCurrentDebugFiberInDEV</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// å¦‚æœcurrent ä¸ºClassComponent åˆ™ä¼šè°ƒç”¨getSnapshotBeforeUpdate</span>
      <span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">resetCurrentDebugFiberInDEV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è°ƒåº¦effect</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="getsnapshotbeforeupdateè°ƒç”¨"><a href="#getsnapshotbeforeupdateè°ƒç”¨" class="header-anchor">#</a> <code>getSnapshotBeforeUpdate</code>è°ƒç”¨</h3> <p>æˆ‘ä»¬çŸ¥é“åœ¨React16åï¼ŒcomponentWillxxxç”Ÿå‘½å‘¨æœŸéƒ½åŠ ä¸Šäº†<code>UNSAFE_</code>å‰ç¼€ã€‚è¿™æ˜¯å› ä¸ºè¿™äº›ç”Ÿå‘½å‘¨æœŸéƒ½æ˜¯åœ¨renderé˜¶æ®µè°ƒç”¨çš„ï¼Œè€Œåœ¨concurrentæ¨¡å¼ä¸‹renderé˜¶æ®µå¯ä»¥è¢«æ‰“æ–­å’Œé‡æ–°è°ƒç”¨ï¼Œä¹Ÿå°±ä¼šå¯¼è‡´è¿™äº›æ–¹æ³•å¤šæ¬¡çš„è°ƒç”¨ã€‚</p> <p>è€Œ<code>getSnapshotBeforeUpdate</code>æ˜¯åœ¨commité˜¶æ®µè°ƒç”¨çš„ï¼Œcommité˜¶æ®µæ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å¤šæ¬¡è°ƒç”¨çš„æƒ…å†µã€‚</p> <p>å¦‚æœåœ¨Class Compenentä¸­æ·»åŠ äº†<code>getSnapshotBeforeUpdate</code>å‡½æ•°ï¼Œå†æ·»åŠ <code>UNSAFE_componentWillMount/componentWillMount</code>ï¼Œ<code>UNSAFE_componentWillReceiveProps/componentWillReceiveProps</code>å’Œ<code>UNSAFE_componentWillUpdate/componentWillUpdate</code>éƒ½ä¸ä¼šåœ¨è¢«è°ƒç”¨</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">const</span> hasNewLifecycles <span class="token operator">=</span>
    <span class="token keyword">typeof</span> getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
    <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">;</span>

 <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span>hasNewLifecycles <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
        <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instance<span class="token punctuation">.</span><span class="token function">componentWillUpdate</span><span class="token punctuation">(</span>newProps<span class="token punctuation">,</span> newState<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instance<span class="token punctuation">.</span><span class="token function">UNSAFE_componentWillUpdate</span><span class="token punctuation">(</span>newProps<span class="token punctuation">,</span> newState<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>æ€»è€Œè¨€ä¹‹ï¼Œ<code>getSnapshotBeforeUpdate</code>æ˜¯ä¸ºäº†è§£å†³å¼‚æ­¥è°ƒç”¨è¿‡ç¨‹ä¸­çš„å¤šæ¬¡è°ƒç”¨é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨ä»£ç ä¸­åº”è¯¥å°½é‡ä½¿ç”¨<code>getSnapshotBeforeUpdate</code>æ¥ä»£æ›¿åŸæ¥çš„ç”Ÿå‘½å‘¨æœŸã€‚</p> <h3 id="è°ƒç”¨useeffect"><a href="#è°ƒç”¨useeffect" class="header-anchor">#</a> è°ƒç”¨useEffect</h3> <p>åœ¨beforeMutitationé˜¶æ®µï¼Œä¼šå°†useEffectåŠ å…¥åˆ°è°ƒåº¦ä»»åŠ¡ä¸­ï¼Œè¯¦ç»†è§£æä¼šåœ¨åé¢è®²è§£useEffectæ—¶è¯¦ç»†è®²è§£ã€‚</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code> <span class="token comment">// è°ƒåº¦effect</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// å¼‚æ­¥è°ƒåº¦useEffect</span>
  <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é‚£ä¹ˆReactä¸ºä»€ä¹ˆä¼šå¼‚æ­¥è°ƒåº¦useEffectå‘¢ï¼Ÿ</p> <p>ä¸ <code>componentDidMount</code>ã€<code>componentDidUpdate</code> ä¸åŒçš„æ˜¯ï¼Œä¼ ç»™ <code>useEffect</code> çš„å‡½æ•°ä¼šåœ¨æµè§ˆå™¨å®Œæˆå¸ƒå±€ä¸ç»˜åˆ¶<strong>ä¹‹å</strong>ï¼Œåœ¨ä¸€ä¸ªå»¶è¿Ÿäº‹ä»¶ä¸­è¢«è°ƒç”¨ã€‚è¿™ä½¿å¾—å®ƒé€‚ç”¨äºè®¸å¤šå¸¸è§çš„å‰¯ä½œç”¨åœºæ™¯ï¼Œæ¯”å¦‚è®¾ç½®è®¢é˜…å’Œäº‹ä»¶å¤„ç†ç­‰æƒ…å†µï¼Œå› ä¸ºç»å¤§å¤šæ•°æ“ä½œä¸åº”é˜»å¡æµè§ˆå™¨å¯¹å±å¹•çš„æ›´æ–°ã€‚</p> <p>ç„¶è€Œï¼Œå¹¶éæ‰€æœ‰ effect éƒ½å¯ä»¥è¢«å»¶è¿Ÿæ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¯¹ç”¨æˆ·å¯è§çš„ DOM å˜æ›´å°±å¿…é¡»åœ¨æµè§ˆå™¨æ‰§è¡Œä¸‹ä¸€æ¬¡ç»˜åˆ¶å‰è¢«åŒæ­¥æ‰§è¡Œï¼Œè¿™æ ·ç”¨æˆ·æ‰ä¸ä¼šæ„Ÿè§‰åˆ°è§†è§‰ä¸Šçš„ä¸ä¸€è‡´ã€‚ï¼ˆæ¦‚å¿µä¸Šç±»ä¼¼äºè¢«åŠ¨ç›‘å¬äº‹ä»¶å’Œä¸»åŠ¨ç›‘å¬äº‹ä»¶çš„åŒºåˆ«ã€‚ï¼‰React ä¸ºæ­¤æä¾›äº†ä¸€ä¸ªé¢å¤–çš„ <a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#uselayouteffect" target="_blank" rel="noopener noreferrer"><code>useLayoutEffect</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Hook æ¥å¤„ç†è¿™ç±» effectã€‚å®ƒå’Œ <code>useEffect</code> çš„ç»“æ„ç›¸åŒï¼ŒåŒºåˆ«åªæ˜¯è°ƒç”¨æ—¶æœºä¸åŒã€‚</p> <p>è™½ç„¶ <code>useEffect</code> ä¼šåœ¨æµè§ˆå™¨ç»˜åˆ¶åå»¶è¿Ÿæ‰§è¡Œï¼Œä½†ä¼šä¿è¯åœ¨ä»»ä½•æ–°çš„æ¸²æŸ“å‰æ‰§è¡Œã€‚åœ¨å¼€å§‹æ–°çš„æ›´æ–°å‰ï¼ŒReact æ€»ä¼šå…ˆæ¸…é™¤ä¸Šä¸€è½®æ¸²æŸ“çš„ effectã€‚</p> <blockquote><p><a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#timing-of-effects" target="_blank" rel="noopener noreferrer">ä»¥ä¸Šæ¥è‡ªå®˜ç½‘<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h3> <p>åœ¨beforeMutationé˜¶æ®µä¼šåšä¸‰ä»¶äº‹ï¼š</p> <ul><li>å¤„ç†blurå’Œfocus DOMèŠ‚ç‚¹</li> <li>è°ƒåº¦<code>getSnapshotBeforeUpdate</code>ç”Ÿå‘½å‘¨æœŸ</li> <li>è°ƒåº¦useEffectï¼ˆæ³¨æ„æ˜¯è°ƒåº¦ï¼Œä¸æ˜¯è°ƒç”¨ï¼‰</li></ul> <h2 id="mutationé˜¶æ®µ"><a href="#mutationé˜¶æ®µ" class="header-anchor">#</a> Mutationé˜¶æ®µ</h2> <p>mutationé˜¶æ®µçš„å…¥å£æ˜¯<code>commitMutationEffects</code></p> <div class="language-tsx extra-class"><pre class="language-tsx"><code>nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
  <span class="token comment">// mutationé˜¶æ®µçš„å…¥å£å‡½æ•°</span>
  <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>commitMutationEffects</code>å‡½æ•°å¦‚ä¸‹ï¼š</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>
<span class="token parameter">root<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
 renderPriorityLevel<span class="token operator">:</span> ReactPriorityLevel<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setCurrentDebugFiberInDEV</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> flags <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> ContentReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commitResetTextContent</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è§£ç»‘ref</span>
        <span class="token function">commitDetachRef</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableScopeAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸‹é¢æ˜¯ä¸´æ—¶æ–¹æ¡ˆï¼Œå¯ä»¥å¿½ç•¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextEffect<span class="token punctuation">.</span>tag <span class="token operator">===</span> ScopeComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">commitAttachRef</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> primaryFlags <span class="token operator">=</span> flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Update <span class="token operator">|</span> Deletion <span class="token operator">|</span> Hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ’å…¥èŠ‚ç‚¹</span>
      <span class="token keyword">case</span> Placement<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is</span>
        <span class="token comment">// inserted, before any life-cycles like componentDidMount gets called.</span>
        <span class="token comment">// TODO: findDOMNode doesn't rely on this any more but isMounted does</span>
        <span class="token comment">// and isMounted is deprecated anyway so we should be able to kill this.</span>
        nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
			<span class="token comment">// æ’å…¥å¹¶æ›´æ–°èŠ‚ç‚¹</span>
      <span class="token keyword">case</span> PlacementAndUpdate<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is</span>
        <span class="token comment">// inserted, before any life-cycles like componentDidMount gets called.</span>
        nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>

        <span class="token comment">// Update</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æœåŠ¡ç«¯æ¸²æŸ“ ssr</span>
      <span class="token keyword">case</span> Hydrating<span class="token operator">:</span> <span class="token punctuation">{</span>
        nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æœåŠ¡ç«¯æ¸²æŸ“</span>
      <span class="token keyword">case</span> HydratingAndUpdate<span class="token operator">:</span> <span class="token punctuation">{</span>
        nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Hydrating<span class="token punctuation">;</span>

        <span class="token comment">// Update</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ›´æ–°</span>
      <span class="token keyword">case</span> Update<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// åˆ é™¤</span>
      <span class="token keyword">case</span> Deletion<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">resetCurrentDebugFiberInDEV</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>commitMutationEffects</code>éå†å…¨éƒ¨çš„effectListï¼Œå¯¹æ¯ä¸ªèŠ‚ç‚¹åšå¦‚ä¸‹å¤„ç†ï¼ˆå¿½ç•¥SSRç›¸å…³ï¼‰</p> <ul><li>é‡ç½®text</li> <li>è§£ç»‘ref</li> <li>æ ¹æ®FiberèŠ‚ç‚¹çš„<code>flag</code>ç±»å‹ï¼Œå†³å®šå¯¹DOMèŠ‚ç‚¹è¦åšçš„æ“ä½œï¼ŒåŒ…æ‹¬å¢åˆ æ”¹</li></ul> <h3 id="å¢-placement"><a href="#å¢-placement" class="header-anchor">#</a> å¢ï¼ˆPlacementï¼‰</h3> <p>å¢åŠ åŠŸèƒ½çš„å…¥å£ä¸º<code>commitPlacement</code>ï¼Œ<code>commitPlacement</code>ä»£ç å¤§è‡´å¦‚ä¸‹ï¼š</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter">finishedWork<span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  	<span class="token comment">// å½“å‰ç¯å¢ƒæ”¯æŒMutation</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsMutation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  	<span class="token comment">// è·å–æœ‰DOMèŠ‚ç‚¹çš„parentèŠ‚ç‚¹ï¼Œtagç±»å‹åŒ…æ‹¬HostComponentï¼ŒHostRootï¼ŒHostPortalï¼ŒFundamentalComponent</span>
    <span class="token keyword">const</span> parentFiber <span class="token operator">=</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// DOM Parent</span>
    <span class="token keyword">let</span> parent<span class="token punctuation">;</span>
  	<span class="token comment">// æ˜¯å¦ä¸ºroot container</span>
    <span class="token keyword">let</span> isContainer<span class="token punctuation">;</span>
    <span class="token keyword">const</span> parentStateNode <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>parentFiber<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> HostComponent<span class="token operator">:</span>
        parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">;</span>
        isContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> HostRoot<span class="token operator">:</span>
        parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
        isContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> HostPortal<span class="token operator">:</span>
        parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
        isContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> FundamentalComponent<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enableFundamentalAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
          isContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// eslint-disable-next-line-no-fallthrough</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">invariant</span><span class="token punctuation">(</span>
          <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token string">'Invalid host parent fiber. This error is likely caused by a bug '</span> <span class="token operator">+</span>
          <span class="token string">'in React. Please file an issue.'</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentFiber<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ContentReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// é‡ç½®textContent</span>
      <span class="token function">resetTextContent</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Clear ContentReset from the effect tag</span>
      parentFiber<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>ContentReset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  	<span class="token comment">// è·å–å½“å‰èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹</span>
    <span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
 		<span class="token comment">// æ’å…¥èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>commitPlacement</code>ä¸»è¦å®Œæˆä¸€ä¸‹å‡ ä»¶äº‹ï¼š</p> <ul><li>è·å–æœ‰DOMèŠ‚ç‚¹çš„FiberèŠ‚ç‚¹ï¼Œå…¥å£å‡½æ•°ä¸º<code>getHostParentFiber</code></li> <li>è·å–Parent DOMèŠ‚ç‚¹</li> <li>è·å–å½“å‰èŠ‚ç‚¹çš„DOMèŠ‚ç‚¹çš„å…„å¼ŸDOMèŠ‚ç‚¹ï¼Œå…¥å£å‡½æ•°ä¸º<code>getHostSibling</code></li> <li>æ’å…¥èŠ‚ç‚¹ï¼Œå…¥å£å‡½æ•°ä¸º<code>insertOrAppendPlacementNodeIntoContainer</code>å’Œ<code>insertOrAppendPlacementNode</code></li></ul> <p>ä»¥ä¸Šå‡ ä»¶äº‹æœ€ä¸»è¦çš„æ˜¯è·å–å…„å¼ŸèŠ‚ç‚¹å’Œæ’å…¥èŠ‚ç‚¹ã€‚</p> <h4 id="gethostsibling"><a href="#gethostsibling" class="header-anchor">#</a> getHostSibling</h4> <p><code>getHostSibling</code>è·å–å…„å¼ŸDOMèŠ‚ç‚¹æ˜¯å¾ˆæœ‰æ„æ€çš„ç®—æ³•ï¼Œå› ä¸ºFiberèŠ‚ç‚¹ä¸æ­¢åŒ…æ‹¬<code>HostComponent</code>èŠ‚ç‚¹ï¼Œè¿˜åŒ…æ‹¬<code>ClassComponent</code>ç­‰èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯DOMèŠ‚ç‚¹å’ŒFiberèŠ‚ç‚¹ä¸æ˜¯åŒçº§çš„ã€‚å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</p> <div class="language-react extra-class"><pre class="language-text"><code>function Test() {
  return (
    &lt;div&gt;1212&lt;/div&gt;
  )
}

class App extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      isShow: false,
    }
  }

  updateCount() {
    this.setState({isShow: !this.state.isShow});
  }

  render() {
    const pNode = this.state.isShow ? &lt;p&gt;test&lt;/p&gt; : null;
    return (
      &lt;div&gt;
        {pNode}
        &lt;Test&gt;&lt;/Test&gt;
        &lt;button onClick={() =&gt; this.updateCount()}&gt;click me&lt;/button&gt;
      &lt;/div&gt;
    )
  }
}
</code></pre></div><p>FiberèŠ‚ç‚¹å¦‚ä¸‹ï¼š</p> <ul><li>this.state.isShow === false</li></ul> <p>Fiber æ ‘</p> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph LR
	APP --&gt; DIV
	DIV --&gt; TEST
	DIV --&gt; BUTTON
	TEST --&gt; TESTDIV
</code></pre></div><p>DOMæ ‘</p> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph LR
	DIV --&gt; TESTDIV
	DIV --&gt; BUTTON
  
</code></pre></div><ul><li>this.state.isShow === ture</li></ul> <p>Fiber æ ‘</p> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph LR
	APP --&gt; DIV
	DIV --&gt; P
	DIV --&gt; TEST
	DIV --&gt; BUTTON
	TEST --&gt; TESTDIV
</code></pre></div><p>DOMæ ‘</p> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph LR
	DIV --&gt; P
	DIV --&gt; TESTDIV
	DIV --&gt; BUTTON
 
</code></pre></div><p>å¦‚ä¸Šï¼ŒPçš„å…„å¼ŸèŠ‚ç‚¹ï¼Œåœ¨DOMæ ‘ä¸Šå’ŒFiberæ ‘ä¸Šæ˜¯ ä¸åŒçº§ï¼Œåœ¨DOMä¹¦ä¸Šï¼ŒPçš„å…„å¼ŸèŠ‚ç‚¹æ˜¯TESTDIVï¼Œåœ¨Fiberæ ‘ä¸ŠPçš„å…„å¼ŸèŠ‚ç‚¹æ˜¯TESTã€‚å¦‚æœæˆ‘ä»¬æƒ³æ‰¾åˆ°Pçš„å…„å¼ŸDOMèŠ‚ç‚¹éœ€è¦è·¨çº§å¯»æ‰¾ï¼Œæ ‘çš„è·¨çº§å¯»æ‰¾çš„å¤æ‚åº¦éƒ½æ˜¯å¾ˆé«˜çš„ã€‚æ‰€ä»¥å¾ªç¯æ’å…¥DOMå¯èƒ½ä¼šæœ‰æ€§èƒ½é—®é¢˜ã€‚</p> <p>ä¸‹é¢è®©æˆ‘ä»¬æ¥çœ‹çœ‹<code>getHostSibling</code>ç®—æ³•çš„å®ç°ï¼š</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>fiber<span class="token operator">:</span> Fiber<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>Instance <span class="token punctuation">{</span>
  <span class="token keyword">let</span> node<span class="token operator">:</span> Fiber <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
  siblings<span class="token operator">:</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œåˆ™å»æŸ¥è¯¢çˆ¶èŠ‚ç‚¹</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>sibling <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">isHostParent</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    node<span class="token punctuation">.</span>sibling<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>
    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> HostComponent <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> HostText <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> DehydratedFragment
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Placement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span> siblings<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostPortal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span> siblings<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æŸ¥æ‰¾å…„å¼ŸèŠ‚ç‚¹çš„å­èŠ‚ç‚¹</span>
        node<span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Placement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="æ’å…¥èŠ‚ç‚¹"><a href="#æ’å…¥èŠ‚ç‚¹" class="header-anchor">#</a> æ’å…¥èŠ‚ç‚¹</h4> <p>æ’å…¥DOMèŠ‚ç‚¹çš„å…¥å£æ˜¯<code>insertOrAppendPlacementNodeIntoContainer</code>å’Œ<code>insertOrAppendPlacementNode</code>ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°æœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°çœŸå®DOMçš„<code>insertBefore</code>æˆ–å‡½æ•°<code>appendChild</code>ã€‚æˆ‘ä»¬ä»¥<code>insertOrAppendPlacementNode</code>è¿›è¡Œåˆ†æï¼š</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>
  node<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  before<span class="token operator">:</span> <span class="token operator">?</span>Instance<span class="token punctuation">,</span>
  parent<span class="token operator">:</span> Instance<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>tag<span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
  <span class="token keyword">const</span> isHost <span class="token operator">=</span> tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> tag <span class="token operator">===</span> HostText<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isHost <span class="token operator">||</span> <span class="token punctuation">(</span>enableFundamentalAPI <span class="token operator">&amp;&amp;</span> tag <span class="token operator">===</span> FundamentalComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœtagä¸ºHostCompponentæˆ–HostTextç±»å‹ï¼Œç›´æ¥å°†DOMæ’å…¥å°±å¥½</span>
    <span class="token keyword">const</span> stateNode <span class="token operator">=</span> isHost <span class="token operator">?</span> node<span class="token punctuation">.</span>stateNode <span class="token operator">:</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">appendChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> HostPortal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»€ä¹ˆéƒ½ä¸åš</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// å½“Tagä¸ä¸ºä»¥ä¸Šæƒ…å†µä¸‹ï¼Œéœ€è¦é€’å½’æ’å…¥</span>
    <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> sibling <span class="token operator">=</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>sibling <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>sibling<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sibling <span class="token operator">=</span> sibling<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬æ¥åˆ†æä¸‹<code>else</code>çš„æƒ…å†µï¼š</p> <div class="language-react extra-class"><pre class="language-text"><code>function Test() {
  return (
    &lt;p&gt;test&lt;/p&gt;
    &lt;div&gt;1212&lt;/div&gt;
  )
}

function App() {
	const [isShow, setIsShow] = useState(false);
  const setIsShowHandler = useCallback(() =&gt; setIsShow(true), []);
  const testNode = isShow ? &lt;Test&gt;&lt;/Test&gt; : null
  return (
    &lt;div&gt;
      {testNode}
      &lt;button onClick={setIsShowHandler}&gt;click me&lt;/button&gt;
    &lt;/div&gt;
  )
}
</code></pre></div><p>å½“æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œä¼šå½¢æˆè¿™æ ·çš„EffectListï¼ŒApp.firstEffect --&gt; Test   Test.nextEffect === nullï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨EffectListä¸­åªæœ‰Test FiberåŠ å…¥åˆ°äº†EffectListä¸­ï¼ŒåŒæ—¶Test Fiberçš„<code>flags</code>å«æœ‰<code>Placement</code>æ ‡è®°ï¼Œæ­¤æ—¶è¦å¾ªç¯å°†<code>p</code>èŠ‚ç‚¹å’Œ<code>div</code>èŠ‚ç‚¹æ’å…¥åˆ°DOMä¸­ã€‚</p> <h3 id="åˆ é™¤-deletion"><a href="#åˆ é™¤-deletion" class="header-anchor">#</a> åˆ é™¤ï¼ˆDeletionï¼‰</h3> <p>åˆ é™¤é€»è¾‘çš„å…¥å£ä¸º<code>commitDeletion</code>ï¼Œ<code>commitDeletion</code>å‡½æ•°ä¼šè°ƒç”¨<code>unmountHostComponents</code>ï¼Œå¹¶æœ€ç»ˆåœ¨<code>unmountHostComponents</code>å‡½æ•°ä¸­å®Œæˆåˆ é™¤é€»è¾‘ï¼Œ<code>unmountHostComponents</code>å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">unmountHostComponents</span><span class="token punctuation">(</span>
<span class="token parameter">finishedRoot<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
 current<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
 renderPriorityLevel<span class="token operator">:</span> ReactPriorityLevel<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// We only have the top Fiber that was deleted but we need to recurse down its</span>
  <span class="token comment">// children to find all the terminal nodes.</span>
  <span class="token keyword">let</span> node<span class="token operator">:</span> Fiber <span class="token operator">=</span> current<span class="token punctuation">;</span>

  <span class="token comment">// Each iteration, currentParent is populated with node's host parent if not</span>
  <span class="token comment">// currentParentIsValid.</span>
  <span class="token keyword">let</span> currentParentIsValid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">// Note: these two variables *must* always be updated together.</span>
  <span class="token keyword">let</span> currentParent<span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentParentIsContainer<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentParentIsValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> parent <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>
      findParent<span class="token operator">:</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invariant</span><span class="token punctuation">(</span>
          parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
          <span class="token string">'Expected to find a host parent. This error is likely caused by '</span> <span class="token operator">+</span>
          <span class="token string">'a bug in React. Please file an issue.'</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> parentStateNode <span class="token operator">=</span> parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> HostComponent<span class="token operator">:</span>
            currentParent <span class="token operator">=</span> parentStateNode<span class="token punctuation">;</span>
            currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span> findParent<span class="token punctuation">;</span>
          <span class="token keyword">case</span> HostRoot<span class="token operator">:</span>
            currentParent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
            currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span> findParent<span class="token punctuation">;</span>
          <span class="token keyword">case</span> HostPortal<span class="token operator">:</span>
            currentParent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
            currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span> findParent<span class="token punctuation">;</span>
          <span class="token keyword">case</span> FundamentalComponent<span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>enableFundamentalAPI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              currentParent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
              currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        parent <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      currentParentIsValid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commitNestedUnmounts</span><span class="token punctuation">(</span>finishedRoot<span class="token punctuation">,</span> node<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// After all the children have unmounted, it is now safe to remove the</span>
      <span class="token comment">// node from the tree.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentParentIsContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeChildFromContainer</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> Container<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>node<span class="token punctuation">.</span>stateNode<span class="token operator">:</span> Instance <span class="token operator">|</span> TextInstance<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">removeChild</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> Instance<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>node<span class="token punctuation">.</span>stateNode<span class="token operator">:</span> Instance <span class="token operator">|</span> TextInstance<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Don't visit children because we already visited them.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>enableFundamentalAPI <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> FundamentalComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fundamentalNode <span class="token operator">=</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
      <span class="token function">commitNestedUnmounts</span><span class="token punctuation">(</span>finishedRoot<span class="token punctuation">,</span> node<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// After all the children have unmounted, it is now safe to remove the</span>
      <span class="token comment">// node from the tree.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentParentIsContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeChildFromContainer</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> Container<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>fundamentalNode<span class="token operator">:</span> Instance<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ é™¤çœŸå®DOM</span>
        <span class="token function">removeChild</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> Instance<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>fundamentalNode<span class="token operator">:</span> Instance<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      enableSuspenseServerRenderer <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">===</span> DehydratedFragment
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSuspenseCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> hydrationCallbacks <span class="token operator">=</span> finishedRoot<span class="token punctuation">.</span>hydrationCallbacks<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hydrationCallbacks <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> onDeleted <span class="token operator">=</span> hydrationCallbacks<span class="token punctuation">.</span>onDeleted<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>onDeleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onDeleted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>stateNode<span class="token operator">:</span> SuspenseInstance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Delete the dehydrated suspense boundary and all of its content.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentParentIsContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearSuspenseBoundaryFromContainer</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> Container<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>node<span class="token punctuation">.</span>stateNode<span class="token operator">:</span> SuspenseInstance<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">clearSuspenseBoundary</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> Instance<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>node<span class="token punctuation">.</span>stateNode<span class="token operator">:</span> SuspenseInstance<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostPortal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// When we go into a portal, it becomes the parent to remove from.</span>
        <span class="token comment">// We will reassign it back when we pop the portal on the way up.</span>
        currentParent <span class="token operator">=</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
        currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// Visit children because portals might contain host components.</span>
        node<span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">commitUnmount</span><span class="token punctuation">(</span>finishedRoot<span class="token punctuation">,</span> node<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Visit children because we may find more host components below.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>child<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>sibling <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> node<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">===</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostPortal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// When we go out of the portal, we need to restore the parent.</span>
        <span class="token comment">// Since we don't keep a stack of them, we will search for it.</span>
        currentParentIsValid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    node<span class="token punctuation">.</span>sibling<span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token keyword">return</span><span class="token punctuation">;</span>
    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/27/2021, 1:38:39 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/react-docs/assets/js/app.ca115495.js" defer></script><script src="/react-docs/assets/js/2.e8a0a8e6.js" defer></script><script src="/react-docs/assets/js/10.3dc71f05.js" defer></script>
  </body>
</html>
